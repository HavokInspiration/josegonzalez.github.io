<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-US">
<!--<![endif]-->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<title>CakeAdvent: Simplifying OAuth integration</title>
		<link rel="profile" href="http://gmpg.org/xfn/11">
		<!--[if lt IE 9]>
			<script src="/javascripts/html5.js" type="text/javascript"></script>
		<![endif]-->
		<meta name="robots" content="all" />
		<meta name="robots" content="index, follow" />
		<meta name="revisit-after" content="7 days" />
		<meta name="version" content="1.0" />

		<meta name="description" content="Rather than writing the same OAuth code for different projects, reuse a community framework to integrate with service providers like Facebook and Twitter" />
		<meta name="keywords" content="cakephp, oauth, authentication" />

		<meta property="og:title" content="CakeAdvent: Simplifying OAuth integration" />
		<meta property="og:type" content="website" />
		<meta property="og:url" content="http://josediazgonzalez.com/2013/12/09/simplifying-oauth-integration/" />
		<meta property="og:description" content="Rather than writing the same OAuth code for different projects, reuse a community framework to integrate with service providers like Facebook and Twitter" />

		<meta name="twitter:card" content="summary">
		<meta name="twitter:site" content="@savant">
		<meta name="twitter:creator" content="@savant">
		<meta name="twitter:title" content="CakeAdvent: Simplifying OAuth integration" />
		<meta name="twitter:description" content="Rather than writing the same OAuth code for different projects, reuse a community framework to integrate with service providers like Facebook and Twitter" />

		<link rel="alternate" type="application/rss+xml" title="Simplifying OAuth integration Â» Feed" href="/atom.xml">
		<link rel="stylesheet" id="twentytwelve-fonts-css" href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700&amp;subset=latin,latin-ext" type="text/css" media="all">
		<link rel="stylesheet" id="twentytwelve-style-css" href="/stylesheets/style.css" type="text/css" media="all">
		<!--[if lt IE 9]>
			<link rel='stylesheet' id='twentytwelve-ie-css'  href='/stylesheets/ie.css' type='text/css' media='all' />
		<![endif]-->

			<script type="text/javascript">
				var _gaq = _gaq || [];
				_gaq.push(['_setAccount', 'UA-8668344-3']);
				_gaq.push(['_trackPageview']);
			</script>

	</head>

	<body class="home  ">
		<div class="site">
			<header class="site-header" role="banner">
				<hgroup>
					<h1 class="site-title">
						<a href="/" title="Jose Diaz-Gonzalez" rel="home">Jose Diaz-Gonzalez</a>
					</h1>
					<h2 class="site-description"><a href="/about/" title="About me">Developer, Accidental Ops Guy, and Professional Troll</a></h2>
				</hgroup>

			</header>

			<div class="wrapper">
				<div class="site-content">
					<div role="main">
						<article class="type-post">
  <header class="entry-header">

      <h1 class="entry-title">
        Simplifying OAuth integration
      </h1>

      <div class="comments-link">
        <a href="#comments" title="Comment on Simplifying OAuth integration!">
          Comments
        </a>
      </div>

  </header>

  <div class="entry-content">

<div class="series-note">

<p>This entry is <strong>part 9</strong> of <strong>21</strong> in the series "CakeAdvent".</p>
<ul>
  <li>Part 1 - <a href="/2013/12/01/testing-your-cakephp-plugins-with-travis/">Testing your CakePHP Plugins with Travis</a></li>

  <li>Part 2 - <a href="/2013/12/02/fun-with-cakephp-views/">Fun with CakePHP Views</a></li>

  <li>Part 3 - <a href="/2013/12/03/hacking-the-cakephp-dispatch-system/">Hacking the CakePHP Dispatch System</a></li>

  <li>Part 4 - <a href="/2013/12/04/interactive-command-line-repl/">Interactive command-line REPL for CakePHP</a></li>

  <li>Part 5 - <a href="/2013/12/05/objectifying-cakephp-2-0-applications/">Objectifying CakePHP 2.0 applications</a></li>

  <li>Part 6 - <a href="/2013/12/06/building-service-classes/">Building Service Classes</a></li>

  <li>Part 7 - <a href="/2013/12/07/a-quick-rundown-on-asset-compression/">A quick rundown on Asset Compression</a></li>

  <li>Part 8 - <a href="/2013/12/08/composing-your-applications-from-plugins/">Composing your applications from plugins</a></li>

  <li>Part 9 - Simplifying OAuth integration</li>

  <li>Part 10 - <a href="/2013/12/10/queue-in-scalable-applications/">Queue in scalable applications</a></li>

  <li>Part 11 - <a href="/2013/12/11/giving-the-gift-of-cakephp-to-the-community/">Giving the gift of CakePHP to the Community</a></li>

  <li>Part 12 - <a href="/2013/12/12/abusing-exceptions-to-provide-model-layer-redirection/">Abusing Exceptions to provide model-layer redirection</a></li>

  <li>Part 13 - <a href="/2013/12/13/simple-application-maintenance-mode/">Simple application maintenance mode</a></li>

  <li>Part 14 - <a href="/2013/12/14/creating-a-custom-session-flash-handler/">Creating a custom session flash handler</a></li>

  <li>Part 15 - <a href="/2013/12/15/payment-processing-using-stripe/">Payment Processing using Stripe</a></li>

  <li>Part 16 - <a href="/2013/12/16/simpler-cakephp-events/">Simpler CakePHP Events</a></li>

  <li>Part 17 - <a href="/2013/12/17/deploy-all-the-things-with-bash/">Deploy ALL the things using simple Bash scripts</a></li>

  <li>Part 18 - <a href="/2013/12/18/cakephp-testing-102/">CakePHP Testing 102</a></li>

  <li>Part 19 - <a href="/2013/12/19/tackling-database-migrations/">Tackling database migrations with one neat trick</a></li>

  <li>Part 20 - <a href="/2013/12/20/application-environment-configuration/">Application Environment Configuration</a></li>

  <li>Part 21 - <a href="/2013/12/21/building-a-behavior-with-cakephp/">Building a Behavior with CakePHP</a></li>
</ul>

</div>

    <p>Handling integration with social services is usually something we have to deal with on a case-by-case basis. Most use some flavor of OAuth, at some random level of the spec with their own customizations. Rather than doing this on a one-off basis, it&#39;s best we use a package that handles all the vagaries and gives us a single, unified api to authenticate users for social services.</p>

<h2>Opauth</h2>

<p>Opauth is a multi-provider authentication framework for PHP. It can integrate with multiple frameworks, one of which is our beloved CakePHP. Let&#39;s install it with Composer:</p>

<pre class="rainbow-code"><code data-language="javascript">&quot;uzyn/cakephp-opauth&quot;: &quot;dev-composer&quot;</code></pre>

<p>Once it&#39;s in our <code>composer.json</code>, install it via <code>composer update</code>. Next you&#39;ll need to load it in your bootstrap.php. It should go after any existing <code>CakePlugin::loadAll()</code> call, simply because we&#39;ll need to load bootstrap and route code as well:</p>

<pre class="rainbow-code"><code data-language="php">&lt;?php
// Ensure you are autoloading composer packages!
if (!include (ROOT . DS . 'vendor' . DS . 'autoload.php')) {
  trigger_error(&quot;Unable to load composer autoloader.&quot;, E_USER_ERROR);
  exit(1);
}

CakePlugin::load('Opauth', array(
  'routes' =&gt; true,
  'bootstrap' =&gt; true
));
?&gt;</code></pre>

<p>Next, you&#39;ll want to add in the validation route. This is an app-specific controller/action that is redirected to with valid user data. You can use this to save the record in association with a user. Place the following in your <code>app/Config/routes.php</code>:</p>

<pre class="rainbow-code"><code data-language="php">&lt;?php
Router::connect(
   '/opauth-complete/*',
   array('controller' =&gt; 'users', 'action' =&gt; 'opauth_complete')
);
?&gt;</code></pre>

<p>And you&#39;ll want to setup the Controller/action:</p>

<pre class="rainbow-code"><code data-language="php">&lt;?php
class UsersController extends AppController {
  public function opauth_complete() {
    debug(json_encode($this-&gt;data, JSON_PRETTY_PRINT));die.
  }
}
?&gt;</code></pre>

<h3>Authentication Strategies</h3>

<p>Once we have setup the plugin, we will need to install some authentications strategies. These are used to enable the integration between your site and, for example, Facebook. Let&#39;s use Github for this example. Install the strategy in your <code>composer.json</code>:</p>

<pre class="rainbow-code"><code data-language="javascript">&quot;opauth/github&quot;: &quot;0.1.0&quot;</code></pre>

<p>And run <code>composer update</code>. Next, we&#39;ll need to configure the strategy in our <code>bootstrap.php</code>. After you&#39;ve loaded the <code>Opauth</code> plugin, place the following:</p>

<pre class="rainbow-code"><code data-language="php">&lt;?php
Configure::write('Opauth.Strategy.GitHub', array(
   'client_id' =&gt; 'YOUR GITHUB APP ID',
   'client_secret' =&gt; 'YOUR GITHUB APP SECRET'
));
?&gt;</code></pre>

<p>At this point, nothing will work because we have not yet created a github application. We can do that in the <a href="https://github.com/settings/applications/new">Github UI</a>. Your callback url will be something like <code>http://example.com/auth/github/oauth2callback</code>, where <code>example.com</code> is what you replace with your domain name.</p>

<p>You can configure other strategies as necessary, and they will be mounted at <code>example.com/auth/STRATEGY_NAME</code>. More strategies are available at the <a href="https://github.com/opauth/opauth#available-strategies">Opauth readme</a>.</p>

<h3>Checking on authentication responses</h3>

<p>At this point, you should visit <code>http://example.com/auth/github</code>. You will be redirected to Github, where it will ask for your authorization to use the application. Confirm and you&#39;ll be redirected to a page with the following JSON output:</p>

<pre class="rainbow-code"><code data-language="javascript">{
    &quot;auth&quot;: {
        &quot;uid&quot;: 65675,
        &quot;info&quot;: {
            &quot;name&quot;: &quot;Jose Diaz-Gonzalez&quot;,
            &quot;urls&quot;: {
                &quot;blog&quot;: &quot;http://josediazgonzalez.com&quot;,
                &quot;github&quot;: &quot;https://github.com/josegonzalez&quot;,
                &quot;github_api&quot;: &quot;https://api.github.com/users/josegonzalez&quot;
            },
            &quot;image&quot;: &quot;https://2.gravatar.com/avatar/b069294dc48acd6c4cfe8b98fc467c89?d=https%3A%2F%2Fidenticons.github.com%2F454a7bfd685393329597fdb7a92b7969.png&amp;r=x&quot;,
            &quot;description&quot;: &quot;CakePHP Developer, have worked on small and large projects and specialize in custom CMS development and API Integration.\r\n\r\nI am also interested in the latest Search and Project Management tools, which was my primary research at Sun Microsystems.&quot;,
            &quot;nickname&quot;: &quot;josegonzalez&quot;,
            &quot;email&quot;: &quot;MY_EMAIL&quot;,
            &quot;location&quot;: &quot;New York, NY&quot;
        },
        &quot;credentials&quot;: {
            &quot;token&quot;: &quot;SOME_TOKEN&quot;
        },
        &quot;raw&quot;: {
          &quot;...MORE DATA...&quot;
        },
        &quot;provider&quot;: &quot;GitHub&quot;
    },
    &quot;timestamp&quot;: &quot;2013-12-09T07:27:34+00:00&quot;,
    &quot;signature&quot;: &quot;SOME_SIGNATURE&quot;,
    &quot;validated&quot;: true
}</code></pre>

<p>We can use this to save a new user. The following is actual production code I use on a site that handles lunch orders I built for a company hackathon:</p>

<pre class="rainbow-code"><code data-language="php">&lt;?php
class UsersController extends AppController {
  public function opauth_complete() {
    try {
      $user = $this-&gt;User-&gt;createOrUpdate($this-&gt;request-&gt;data);
      $this-&gt;Auth-&gt;login($user-&gt;toLoginArray());

      $this-&gt;Session-&gt;success(__(&quot;%s, you have successfully logged in&quot;, $user-&gt;first_name));
      return $this-&gt;redirect(array('action' =&gt; 'dashboard'));
    } catch (Exception $e) {
      $this-&gt;Session-&gt;danger($e-&gt;getMessage());
      return $this-&gt;redirect(array('action' =&gt; 'oauth_failed'));
    }
  }
?&gt;</code></pre>

<p>And the User Model:</p>

<pre class="rainbow-code"><code data-language="php">&lt;?php
App::uses('EntityModel', 'Entity.Model');
App::uses('UserEntity', 'Model/Entity');

class User extends EntityModel {
  public $entity = true;

  public function createOrUpdate($data) {
    if (empty($data['auth']['credentials']['token'])) {
      throw new Exception('Missing oauth token');
    }

    if (empty($data['validated'])) {
      throw new Exception('Invalid oauth login');
    }

    $user = $this-&gt;find('first', array(
      'conditions' =&gt; array(
        'Authorization.user_id' =&gt; $data['auth']['uid'],
        'Authorization.provider' =&gt; $data['auth']['provider'],
      ),
      'contain' =&gt; array('Authorization'),
    ));

    if (!$user) {
      $user = $this-&gt;entity();
    }

    // Method that ensures we have the attached authorization
    $user-&gt;updateFromLogin($data);
    $user-&gt;save();

    return $user;
  }
}
?&gt;</code></pre>

<h2>Closing Thoughts</h2>

<p>Integrating OAuth sign-on with your website doesn&#39;t have to be scary, but you should definitely invest time in investigating how to do it right. Opauth can save you a lot of time, but be sure to look into how exactly you want to model your data :)</p>

  </div>

    <footer class="entry-meta">
      This entry was posted in <a href="/categories/code" title="View all posts in Code" rel="category">Code</a> on <a href="http://josediazgonzalez.com/2013/12/09/simplifying-oauth-integration/" title="10:40 pm" rel="bookmark"><time class="entry-date" datetime="2013-12-09 00:55:00 -0500">09 Dec 2013</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="/about/" title="See more info on Jose Diaz-Gonzalez" rel="author">Jose Diaz-Gonzalez</a></span></span>.
    </footer>

</article>

  <div id="comments">
    <div id="disqus_thread" name="#comments"></div>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>

					</div>
				</div>
				<div class="widget-area" role="complementary">

					<aside class="widget widget_categories widget_search">
							<input class="typeahead tt-query" type="text" placeholder="search for articles" autocomplete="off" spellcheck="false" dir="auto" style="position: relative; vertical-align: top; background-color: transparent; width: 94%">
							<br />
							<br />
							<br />
						<h3 class="widget-title">Categories</h3>
						<ul>

								<li class="cat-item"><a href="/categories/cakephp"title="View all posts filed under Cakephp">Cakephp</a></li>

								<li class="cat-item"><a href="/categories/code"title="View all posts filed under Code">Code</a></li>

								<li class="cat-item"><a href="/categories/dev-log"title="View all posts filed under Dev Log">Dev Log</a></li>

								<li class="cat-item"><a href="/categories/devops"title="View all posts filed under Devops">Devops</a></li>

								<li class="cat-item"><a href="/categories/installation"title="View all posts filed under Installation">Installation</a></li>

								<li class="cat-item"><a href="/categories/interviews"title="View all posts filed under Interviews">Interviews</a></li>

								<li class="cat-item"><a href="/categories/other"title="View all posts filed under Other">Other</a></li>

								<li class="cat-item"><a href="/categories/rant"title="View all posts filed under Rant">Rant</a></li>

						</ul>
					</aside>

				</div>
			</div>
			<footer class="colophon" role="contentinfo">
				<div class="site-info">
					<a href="http://github.com/josegonzalez/cimino" title="Semantic Personal Publishing Platform">Proudly powered by Cimino</a>
				</div>
			</footer>
		</div>

		<script type="text/javascript" src="/javascripts/style.js"></script>
		<script type="text/javascript">

			if ($('#disqus_thread').length) {
				var disqus_shortname  = 'josediazgonzalez';
				var disqus_identifier = '/2013/12/09/simplifying-oauth-integration/';
				var disqus_url        = 'http://josediazgonzalez.com/2013/12/09/simplifying-oauth-integration/';
				var disqus_title      = 'CakeAdvent: Simplifying OAuth integration';

				(function() {
					var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
					dsq.src = 'http://' + 'josediazgonzalez' + '.disqus.com/embed.js';
					(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				})();
			}

				(function() {
					var ga = document.createElement('script');     ga.type = 'text/javascript'; ga.async = true;
					ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
					var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
				})();

		</script>
	</body>
</html>